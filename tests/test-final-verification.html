<!DOCTYPE html>
<html>
<head>
    <title>Final Verification Test</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .success { color: #00ff88; font-weight: bold; }
        .error { color: #ff6b6b; font-weight: bold; }
        .warning { color: #ffaa00; font-weight: bold; }
        .info { color: #7877c6; }
        h2 { color: #7877c6; margin-top: 0; }
        code {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>üîç Extension Final Verification Test</h1>
    
    <div class="test-section">
        <h2>1. Script Loading Order Test</h2>
        <div id="loading-test"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Day.js Functionality Test</h2>
        <div id="dayjs-test"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Storage Access Test</h2>
        <div id="storage-test"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Date Widget Simulation</h2>
        <div id="widget-test"></div>
    </div>

    <!-- Simulate exact loading from newtab.html -->
    <script>
        const loadingTest = document.getElementById('loading-test');
        const dayjsTest = document.getElementById('dayjs-test');
        const storageTest = document.getElementById('storage-test');
        const widgetTest = document.getElementById('widget-test');
        
        let loadOrder = [];
        
        // Track loading order
        loadingTest.innerHTML = '<p class="info">Simulating newtab.html script loading order...</p>';
    </script>
    
    <!-- Mock DOM elements that settings.js expects -->
    <div id="settings-button" style="display:none"></div>
    <div id="settings-modal" style="display:none"></div>
    <div id="close-settings" style="display:none"></div>
    
    <!-- Core extension scripts -->
    <script>
        loadOrder.push('Core scripts loading...');
        // Mock the settings object
        window.settings = { widgets: [] };
        window.saveAndRender = function() {};
        window.widgetRegistry = {};
        window.registerWidget = function(type, def) { widgetRegistry[type] = def; };
        window.widgetList = document.createElement('div');
        window.widgetGrid = document.createElement('div');
        window.activeIntervals = [];
        window.createWidgetContainer = function() { return document.createElement('div'); };
        window.applyWidgetAppearance = function() {};
        window.setupJiggleModeControls = function() {};
        window.setupWidgetConfigButtons = function() {};
    </script>
    
    <!-- Day.js library -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/advancedFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/localizedFormat.js"></script>
    <script>
        loadOrder.push('Day.js loading...');
        if (typeof dayjs !== 'undefined') {
            loadOrder.push('Day.js loaded successfully');
            if (window.dayjs_plugin_advancedFormat) {
                dayjs.extend(window.dayjs_plugin_advancedFormat);
                loadOrder.push('AdvancedFormat plugin extended');
            }
            if (window.dayjs_plugin_localizedFormat) {
                dayjs.extend(window.dayjs_plugin_localizedFormat);
                loadOrder.push('LocalizedFormat plugin extended');
            }
        } else {
            loadOrder.push('ERROR: Day.js failed to load!');
        }
    </script>
    
    <!-- Widget implementations -->
    <script src="extension/widgets/date-widget.js"></script>
    <script>
        loadOrder.push('Date widget loaded');
    </script>
    
    <!-- Run tests after everything loads -->
    <script>
        setTimeout(() => {
            // Display loading order
            loadingTest.innerHTML += loadOrder.map(item => 
                `<p>${item.includes('ERROR') ? '<span class="error">‚ùå</span>' : '<span class="success">‚úÖ</span>'} ${item}</p>`
            ).join('');
            
            // Test Day.js functionality
            if (typeof dayjs !== 'undefined') {
                dayjsTest.innerHTML = '<p class="success">‚úÖ Day.js is available globally</p>';
                
                const tests = [
                    { format: 'YYYY-MM-DD', desc: 'Basic date' },
                    { format: 'MMMM Do, YYYY', desc: 'Ordinal date (needs plugin)' },
                    { format: 'L', desc: 'Localized format (needs plugin)' },
                    { format: '[Today is] dddd', desc: 'Literal text' }
                ];
                
                tests.forEach(test => {
                    try {
                        const result = dayjs().format(test.format);
                        const success = result !== test.format;
                        dayjsTest.innerHTML += `<p>${success ? '<span class="success">‚úÖ</span>' : '<span class="warning">‚ö†Ô∏è</span>'} ${test.desc}: <code>${test.format}</code> ‚Üí <strong>${result}</strong></p>`;
                    } catch (e) {
                        dayjsTest.innerHTML += `<p><span class="error">‚ùå</span> ${test.desc}: Error - ${e.message}</p>`;
                    }
                });
            } else {
                dayjsTest.innerHTML = '<p class="error">‚ùå Day.js is NOT available!</p>';
            }
            
            // Test storage access
            storageTest.innerHTML = '<p class="info">Testing storage mechanisms...</p>';
            
            // Test localStorage
            try {
                localStorage.setItem('test', 'value');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');
                storageTest.innerHTML += '<p class="success">‚úÖ localStorage is accessible</p>';
            } catch (e) {
                storageTest.innerHTML += '<p class="error">‚ùå localStorage error: ' + e.message + '</p>';
            }
            
            // Test chrome.storage
            if (typeof chrome !== 'undefined' && chrome.storage) {
                storageTest.innerHTML += '<p class="success">‚úÖ chrome.storage API is available (Extension mode)</p>';
            } else {
                storageTest.innerHTML += '<p class="warning">‚ö†Ô∏è chrome.storage API not available (File mode)</p>';
            }
            
            // Test date widget functionality
            widgetTest.innerHTML = '<p class="info">Testing date widget registration...</p>';
            
            if (window.widgetRegistry && window.widgetRegistry.date) {
                widgetTest.innerHTML += '<p class="success">‚úÖ Date widget registered successfully</p>';
                
                // Test if widget can render
                try {
                    const testWidget = {
                        type: 'date',
                        settings: { format: 'YYYY-MM-DD HH:mm:ss' }
                    };
                    
                    // Create a test container
                    const testContainer = document.createElement('div');
                    testContainer.id = 'test-widget-container';
                    widgetTest.appendChild(testContainer);
                    
                    // Test the render function
                    widgetTest.innerHTML += '<p class="info">Attempting to render date widget...</p>';
                    
                    // Check if Day.js is available for the widget
                    if (typeof dayjs !== 'undefined') {
                        const formatted = dayjs().format(testWidget.settings.format);
                        widgetTest.innerHTML += `<p class="success">‚úÖ Date widget can format: <strong>${formatted}</strong></p>`;
                    } else {
                        widgetTest.innerHTML += '<p class="error">‚ùå Day.js not available for widget</p>';
                    }
                    
                } catch (e) {
                    widgetTest.innerHTML += `<p class="error">‚ùå Widget render error: ${e.message}</p>`;
                }
            } else {
                widgetTest.innerHTML += '<p class="error">‚ùå Date widget NOT registered!</p>';
            }
            
            // Final summary
            const allSuccess = !document.body.innerHTML.includes('‚ùå');
            const summary = document.createElement('div');
            summary.className = 'test-section';
            summary.innerHTML = `
                <h2>Summary</h2>
                <p class="${allSuccess ? 'success' : 'error'}" style="font-size: 1.5em;">
                    ${allSuccess ? 'üéâ All tests passed!' : '‚ö†Ô∏è Some tests failed - check above for details'}
                </p>
                <p class="info">
                    <strong>Mode Detection:</strong><br>
                    ${typeof chrome !== 'undefined' && chrome.storage ? 
                        'üåê Running in Extension context' : 
                        'üìÅ Running in File:// context'}
                </p>
            `;
            document.body.appendChild(summary);
            
        }, 500); // Wait for all scripts to fully load
    </script>
</body>
</html>